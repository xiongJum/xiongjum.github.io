<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Locust - LongLit</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="locast 是一種易於使用、可編寫脚本且可擴展的性能測試工具。
在常規 Python 代碼中定義用戶的行爲。
開始使用 Local" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Locust" />
<meta property="og:description" content="locast 是一種易於使用、可編寫脚本且可擴展的性能測試工具。
在常規 Python 代碼中定義用戶的行爲。
開始使用 Local" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiongjum.github.io/post/code/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95-locust/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Locust"/>
<meta name="twitter:description" content="locast 是一種易於使用、可編寫脚本且可擴展的性能測試工具。
在常規 Python 代碼中定義用戶的行爲。
開始使用 Local"/>
<script src="https://xiongjum.github.io/js/feather.min.js"></script>
	
	
        <link href="https://xiongjum.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://xiongjum.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://xiongjum.github.io/">LongLit</a>
	</div>
	<div>
		<a href="/categories/编程">编程</a>
		<a href="/categories/玩机">玩机</a>
		<a href="/categories/笔记">笔记</a>
	</div>
	<nav>
		
		<a href="/post">文章</a>
		
		<a href="/tags">标签</a>
		
		<a href="/mark">书签</a>
		
		<a href="/about">关于</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Locust</h1>
			<div class="meta">Posted on May 28, 2020</div>
		</div>
		

		<section class="body">
			<p>locast 是一種易於使用、可編寫脚本且可擴展的性能測試工具。</p>
<p>在常規 Python 代碼中定義用戶的行爲。</p>
<p>開始使用 <a href="https://locust.io/">Local</a></p>
<h4 id="安装-locust">安装 Locust</h4>
<p>安装 locast 和 geventhttpclient。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pip3 install locast, geventhttpclient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 查看是否安装成功
</span></span><span style="display:flex;"><span>locust -v
</span></span></code></pre></div><blockquote>
<p>若安装失败，<a href="https://github.com/locustio/locust/wiki/Installation">点击这排查问题</a></p>
</blockquote>
<h4 id="locust-快速入门">locust 快速入门</h4>
<h5 id="编写执行文本">编写执行文本</h5>
<p>导入 locust.HttpUser 即可编写简单的 locust 文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># mylocast.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, between
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">updateVesion</span>(Httpset):
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 若在类中申明了host属性，则不需要再命令行中另行申明--host,若在命令行中另行申明了-host，则不再使用该host属性</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://118.190.124.69:7080&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">updateTest</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>port(url,data)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(url)
</span></span></code></pre></div><p>在命令行执行locust文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 执行 locust 文件
</span></span><span style="display:flex;"><span>locust -f mylocut.py
</span></span><span style="display:flex;"><span># 执行文件中没有申明 host 或者覆盖执行文件中的host
</span></span><span style="display:flex;"><span>locust -f mylocut.py --host=http://118.190.124.69:7080
</span></span></code></pre></div><p>使用 @task() <a href="https://docs.python.org/zh-cn/3/library/typing.html#functions-and-decorators">装饰器</a> 传入参数，设置单个类中多个函数的执行效率；设置 weight <a href="/tags/%E5%8F%98%E9%87%8F">#变量</a> 则可以设置多个 locust 的执行效率；数字越高则代表执行效率越高
若需要设置等待时间，则需要导入  between 或  constant 模块，设置等待区间或者具体的等待时间，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task, between, constant
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;设置多个 locust 类，变更设置执行效率&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">updateVesion</span>(HttpUser):
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> constant(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">updateTest</span>(self):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url, json<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@task</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>login_url, json<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">loginTest</span>(HttpUser):
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> between(<span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">2.1</span>)
</span></span><span style="display:flex;"><span>    weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>(self):
</span></span><span style="display:flex;"><span>        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>}
</span></span><span style="display:flex;"><span>        url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/city-api/wx/logout?token=tangsx&#34;</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;USERNAME&#34;</span>:<span style="color:#e6db74">&#34;17134025282&#34;</span>}
</span></span><span style="display:flex;"><span>     	self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url, json<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span></code></pre></div><p>一般浏览网页时会一级级的向下点击，为模拟用户的真实操作，可以使用TaskSet 进行嵌套处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> HttpUser, task, between, TaskSet
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">logIn</span>(TaskSet):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url,json<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">update</span>(TaskSet):
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> [logIn]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">updateTest</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url, json<span style="color:#f92672">=</span>data, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">runLog</span>(HttpUser):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># tasks是python的可调用函数，他们接受一个参数——正在执行任务的TaskSet类实例</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> [logOut]
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> between(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p>两个Locust类并行，并设置执行比例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">logIn</span>(TaskSet):
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">runLog</span>(HttpUser):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># tasks是python的可调用函数，他们接受一个参数——正在执行任务的TaskSet类实例</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> {logIn:<span style="color:#ae81ff">3</span>, update: <span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> between(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p>设置 Locust 的 csv 文件写入速度</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> locust.stats
</span></span><span style="display:flex;"><span>locust<span style="color:#f92672">.</span>stats<span style="color:#f92672">.</span>CSV_STATS_INTERVAL_SEC <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 默认为2s</span>
</span></span></code></pre></div><h5 id="命令行命令">命令行命令</h5>
<p>设置无界面运行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>locust -f <span style="color:#f92672">[</span>文件名<span style="color:#f92672">]</span> --host<span style="color:#f92672">[</span>网址<span style="color:#f92672">]</span> --headless <span style="color:#f92672">[</span>无Web_UI<span style="color:#f92672">]</span> -u <span style="color:#f92672">[</span>模拟用户数<span style="color:#f92672">]</span> -r <span style="color:#f92672">[</span>用户孵化数<span style="color:#f92672">]</span> -t <span style="color:#f92672">[</span>运行时间<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置无界面运行的关键参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  --headless</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 若执行文件没有写明，以下为必填参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## -r 用户孵化数，模拟的真实的用户</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## -u 模拟用户数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 选填参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## -t 设置运行时间，单位时(h)、分(m)、秒(s), 和 --headless 进行关联</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## --csv=[文件名]  以 csv 格式储存当前测试数据</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## -L 级别为[DEBUG/INFO/WARNING/ERROR/CRITICAL], 默认为INFO</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## --logfile=[路径]  log日志的储存路径，若没有设置则在stdout/stderr</span>
</span></span></code></pre></div><p>多机器分布测试</p>
<p>主机和分机需要在同一个局域网下，或者设置的ip为外网；主机只显示测试数据，不执行性能测试，且主机和分机的执行文件需要一致</p>
<p>主机的执行的命令行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Locust -f <span style="color:#f92672">[</span>文件名<span style="color:#f92672">]</span> --master
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可选参数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --master-bind-host = [IP] 将主机绑定到特定的网络上，若不填写则为本机默认的ipv4网络</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --master-bind-prot = [port] 设置主机的监听端口，默认为5557， 会占用两个端口，为指定端口+1和指定端口</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --expect-workers = [数量] 等待X个分机连接后，进行测试（命令行模式下使用）</span>
</span></span></code></pre></div><p>分机执行的命令行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>locust -f <span style="color:#f92672">[</span>文件名<span style="color:#f92672">]</span> --worker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --master-host = [ip] 值和主机设置的值一致；必填</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --master-port = [port] 值和主机设置的值一致；若主机没有特殊指定，则分机不需要特殊设置</span>
</span></span></code></pre></div><h4 id="提高http请求性能">提高Http请求性能</h4>
<p>通过FastHttpLocust提高Locust的Http请求性能</p>
<blockquote>
<ol>
<li>通常情况下我们只需要使用 requests 来实现HTTP请求，若执行脚本时花费了大量的CPU时间，可以切换到 FastHttpLocust</li>
<li>FastHttpLocust 无法完全替代 HttpLocust。</li>
</ol>
</blockquote>
<p>示例代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> locust <span style="color:#f92672">import</span> TaskSet, task, between
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> locust.contrib.fasthttp <span style="color:#f92672">import</span> FastHttpLocust
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTaskSet</span>(TaskSet):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@task</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>(self):
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyLocust</span>(FastHttpLocust):
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> [MyTaskSet]
</span></span><span style="display:flex;"><span>    wait_time <span style="color:#f92672">=</span> between(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><hr>
<h4 id="参考">参考</h4>
<p>[1] <a href="https://www.axihe.com/tools/locust/home.html">阿西河博客</a>
[2] <a href="https://docs.locust.io/">Locust IO文档</a></p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/python3">python3</a></li>
					
					<li><a href="/tags/%E6%B5%8B%E8%AF%95">测试</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/athul/archie" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © LongLit |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
