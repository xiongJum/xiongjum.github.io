<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>性能测试 for Locust · Lain</title><meta name="description" content="性能测试 for Locust - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-light.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.lain.buzz/atom.xml" title="Lain"><meta name="generator" content="Hexo 7.0.0-rc1"><link rel="alternate" href="/atom.xml" title="Lain" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/favorites" target="_self" class="nav-list-link">LINK</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://web.lain.buzz" target="_blank" class="nav-list-link">FAVORITES</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">性能测试 for Locust</h1><div class="tags"><a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" class="tag-title">#性能测试</a><a href="/tags/Python/" class="tag-title">#Python</a><a href="/tags/Locust/" class="tag-title">#Locust</a><a href="/tags/%E6%B5%8B%E8%AF%95/" class="tag-title">#测试</a></div><div class="post-info">2020年5月28日</div><div class="post-content"><p>locast 是一種易於使用、可編寫脚本且可擴展的性能測試工具。</p>
<p>在常規 Python 代碼中定義用戶的行爲。</p>
<p>開始使用 <a target="_blank" rel="noopener" href="https://locust.io/">Local</a></p>
<span id="more"></span>


<h4 id="安装-Locust"><a href="#安装-Locust" class="headerlink" title="安装 Locust"></a>安装 Locust</h4><p>安装 locast 和 geventhttpclient。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">pip3 install locast, geventhttpclient<br><br># 查看是否安装成功<br>locust -v<br></code></pre></td></tr></table></figure>

<blockquote>
<p>若安装失败，<a target="_blank" rel="noopener" href="https://github.com/locustio/locust/wiki/Installation">点击这排查问题</a></p>
</blockquote>
<h4 id="locust-快速入门"><a href="#locust-快速入门" class="headerlink" title="locust 快速入门"></a>locust 快速入门</h4><h5 id="编写执行文本"><a href="#编写执行文本" class="headerlink" title="编写执行文本"></a>编写执行文本</h5><p>导入 locust.HttpUser 即可编写简单的 locust 文件。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># mylocast.py</span><br><br><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpUser, between<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">updateVesion</span>(<span class="hljs-title class_ inherited__">Httpset</span>):<br>  <br>    <span class="hljs-comment"># 若在类中申明了host属性，则不需要再命令行中另行申明--host,若在命令行中另行申明了-host，则不再使用该host属性</span><br>    host = <span class="hljs-string">&#x27;http://118.190.124.69:7080&#x27;</span><br><span class="hljs-meta">    @task</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">updateTest</span>(<span class="hljs-params">self</span>):<br>        self.client.port(url,data)<br>        self.client.get(url)<br></code></pre></td></tr></table></figure>

<p>在命令行执行locust文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># 执行 locust 文件<br>locust -f mylocut.py<br># 执行文件中没有申明 host 或者覆盖执行文件中的host<br>locust -f mylocut.py --host=http://118.190.124.69:7080<br></code></pre></td></tr></table></figure>

<p>使用 @task() <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/typing.html#functions-and-decorators">装饰器</a> 传入参数，设置单个类中多个函数的执行效率；设置 weight <a href="/tags/%E5%8F%98%E9%87%8F">#变量</a> 则可以设置多个 locust 的执行效率；数字越高则代表执行效率越高<br>若需要设置等待时间，则需要导入  between 或  constant 模块，设置等待区间或者具体的等待时间， </p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpUser, task, between, constant<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-string">&quot;&quot;&quot;设置多个 locust 类，变更设置执行效率&quot;&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">class updateVesion(HttpUser):</span><br><span class="hljs-string">    wait_time = constant(1)</span><br><span class="hljs-string">    weight = 3</span><br><span class="hljs-string">    @task(1)</span><br><span class="hljs-string">    def updateTest(self):</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        self.client.post(url=url, json=data, headers=headers)</span><br><span class="hljs-string"></span><br><span class="hljs-string">	@task(3)</span><br><span class="hljs-string">    def login(self):</span><br><span class="hljs-string">        self.client.post(url=login_url, json=data, headers=headers)</span><br><span class="hljs-string">		</span><br><span class="hljs-string">class loginTest(HttpUser):</span><br><span class="hljs-string">    wait_time = between(1.3, 2.1)</span><br><span class="hljs-string">    weight = 1</span><br><span class="hljs-string">	</span><br><span class="hljs-string">    def logout(self):</span><br><span class="hljs-string">        headers = &#123;&quot;</span>Content-<span class="hljs-type">Type</span><span class="hljs-string">&quot;: &quot;</span>application/json<span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string">        url = &quot;</span>/city-api/wx/logout?token=tangsx<span class="hljs-string">&quot;</span><br><span class="hljs-string">        data = &#123;&quot;</span>USERNAME<span class="hljs-string">&quot;:&quot;</span><span class="hljs-number">17134025282</span><span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string">     	self.client.post(url=url, json=data, headers=headers)</span><br></code></pre></td></tr></table></figure>

<p>一般浏览网页时会一级级的向下点击，为模拟用户的真实操作，可以使用TaskSet 进行嵌套处理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpUser, task, between, TaskSet<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">logIn</span>(<span class="hljs-title class_ inherited__">TaskSet</span>):<br>    <br><span class="hljs-meta">    @task</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        self.client.post(url=url,json=data, headers=headers)<br>		<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">update</span>(<span class="hljs-title class_ inherited__">TaskSet</span>):<br>    tasks = [logIn]<br>    <br><span class="hljs-meta">    @task</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">updateTest</span>(<span class="hljs-params">self</span>):<br>        self.client.post(url=url, json=data, headers=headers)<br>        <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">runLog</span>(<span class="hljs-title class_ inherited__">HttpUser</span>):<br>    <span class="hljs-comment"># tasks是python的可调用函数，他们接受一个参数——正在执行任务的TaskSet类实例</span><br>    <br>    tasks = [logOut]<br>    wait_time = between(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p>两个Locust类并行，并设置执行比例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">logIn</span>(<span class="hljs-title class_ inherited__">TaskSet</span>):<br>...<br>...<br>...<br>        <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">runLog</span>(<span class="hljs-title class_ inherited__">HttpUser</span>):<br>    <span class="hljs-comment"># tasks是python的可调用函数，他们接受一个参数——正在执行任务的TaskSet类实例</span><br>    <br>    tasks = &#123;logIn:<span class="hljs-number">3</span>, update: <span class="hljs-number">1</span>&#125;<br>    wait_time = between(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p>设置 Locust 的 csv 文件写入速度</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> locust.stats<br>locust.stats.CSV_STATS_INTERVAL_SEC = <span class="hljs-number">5</span> <span class="hljs-comment"># 默认为2s</span><br></code></pre></td></tr></table></figure>

<h5 id="命令行命令"><a href="#命令行命令" class="headerlink" title="命令行命令"></a>命令行命令</h5><p>设置无界面运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">locust -f [文件名] --host[网址] --headless [无Web_UI] -u [模拟用户数] -r [用户孵化数] -t [运行时间]<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置无界面运行的关键参数</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#  --headless</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">若执行文件没有写明，以下为必填参数</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># -r 用户孵化数，模拟的真实的用户</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># -u 模拟用户数</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">选填参数</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># -t 设置运行时间，单位时(h)、分(m)、秒(s), 和 --headless 进行关联</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># --csv=[文件名]  以 csv 格式储存当前测试数据</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># -L 级别为[DEBUG/INFO/WARNING/ERROR/CRITICAL], 默认为INFO</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># --logfile=[路径]  log日志的储存路径，若没有设置则在stdout/stderr</span></span><br><br></code></pre></td></tr></table></figure>


<p>多机器分布测试</p>
<p>主机和分机需要在同一个局域网下，或者设置的ip为外网；主机只显示测试数据，不执行性能测试，且主机和分机的执行文件需要一致</p>
<p>主机的执行的命令行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">Locust -f [文件名] --master<br><span class="hljs-meta prompt_"># </span><span class="language-bash">可选参数</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--master-bind-host = [IP] 将主机绑定到特定的网络上，若不填写则为本机默认的ipv4网络</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--master-bind-prot = [port] 设置主机的监听端口，默认为5557， 会占用两个端口，为指定端口+1和指定端口</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--expect-workers = [数量] 等待X个分机连接后，进行测试（命令行模式下使用）</span><br></code></pre></td></tr></table></figure>

<p> 分机执行的命令行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">locust -f [文件名] --worker<br><span class="hljs-meta prompt_"># </span><span class="language-bash">--master-host = [ip] 值和主机设置的值一致；必填</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--master-port = [port] 值和主机设置的值一致；若主机没有特殊指定，则分机不需要特殊设置</span><br></code></pre></td></tr></table></figure>

<h4 id="提高Http请求性能"><a href="#提高Http请求性能" class="headerlink" title="提高Http请求性能"></a>提高Http请求性能</h4><p>通过FastHttpLocust提高Locust的Http请求性能</p>
<blockquote>
<ol>
<li>通常情况下我们只需要使用 requests 来实现HTTP请求，若执行脚本时花费了大量的CPU时间，可以切换到 FastHttpLocust</li>
<li>FastHttpLocust 无法完全替代 HttpLocust。</li>
</ol>
</blockquote>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> TaskSet, task, between<br><span class="hljs-keyword">from</span> locust.contrib.fasthttp <span class="hljs-keyword">import</span> FastHttpLocust<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTaskSet</span>(<span class="hljs-title class_ inherited__">TaskSet</span>):<br><span class="hljs-meta">    @task</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">self</span>):<br>        response = self.client.get(<span class="hljs-string">&quot;/&quot;</span>)<br>    <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLocust</span>(<span class="hljs-title class_ inherited__">FastHttpLocust</span>):<br>    tasks = [MyTaskSet]<br>    wait_time = between(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p>[1] <a target="_blank" rel="noopener" href="https://www.axihe.com/tools/locust/home.html">阿西河博客</a><br>[2] <a target="_blank" rel="noopener" href="https://docs.locust.io/">Locust IO文档</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/06/28/system_linux%E4%B9%8Bshell/" class="prev">PREV</a><a href="/2020/04/23/code_Python%E8%A7%A3%E9%87%8A%E5%99%A8/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2023 <a href="https://blog.lain.buzz"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { hljs.configure({useBR: true}); $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>